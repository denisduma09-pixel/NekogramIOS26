name: üöÄ ULTIMATE KOTUKTOPER BUILD

on: 
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Ultimate Build Setup
      run: |
        chmod +x gradlew
        
        # –§—É–Ω–∫—Ü–∏—è —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–∞
        echo 'start_timer() { 
          local start=$SECONDS
          while kill -0 $2 2>/dev/null; do
            local duration=$((SECONDS - start))
            echo "‚è±Ô∏è [$1] –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è: ${duration}—Å–µ–∫..."
            sleep 5
          done
        }' > timer.sh
        
        # –û–ß–ò–°–¢–ö–ê –ò –ü–û–î–ì–û–¢–û–í–ö–ê
        echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
        timeout 2m ./gradlew clean --no-daemon &
        CLEAN_PID=$!
        source timer.sh "Clean" $CLEAN_PID &
        TIMER_PID=$!
        wait $CLEAN_PID || echo "‚ö†Ô∏è Clean –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
        kill $TIMER_PID 2>/dev/null || true
        
        # –ö–ê–°–ö–ê–î–ù–ê–Ø –°–ë–û–†–ö–ê –° –°–ï–ö–£–ù–î–û–ú–ï–†–û–ú
        echo "üîß –ü–æ–ø—ã—Ç–∫–∞ 1: –û—Å–Ω–æ–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞ (5 –º–∏–Ω—É—Ç)..."
        timeout 5m ./gradlew :TMessagesProj:assembleDebug --no-daemon --stacktrace --info &
        BUILD1_PID=$!
        source timer.sh "–°–±–æ—Ä–∫–∞ 1" $BUILD1_PID &
        TIMER1_PID=$!
        wait $BUILD1_PID && echo "‚úÖ –°–±–æ—Ä–∫–∞ 1 —É—Å–ø–µ—à–Ω–∞!" || \
        
        (kill $TIMER1_PID 2>/dev/null || true
        echo "üîß –ü–æ–ø—ã—Ç–∫–∞ 2: –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ (4 –º–∏–Ω—É—Ç—ã)..."
        timeout 4m ./gradlew :TMessagesProj:assembleDebug --no-daemon --no-build-cache --no-configuration-cache &
        BUILD2_PID=$!
        source timer.sh "–°–±–æ—Ä–∫–∞ 2" $BUILD2_PID &
        TIMER2_PID=$!
        wait $BUILD2_PID && echo "‚úÖ –°–±–æ—Ä–∫–∞ 2 —É—Å–ø–µ—à–Ω–∞!" || \
        
        (kill $TIMER2_PID 2>/dev/null || true
        echo "üîß –ü–æ–ø—ã—Ç–∫–∞ 3: –°–±–æ—Ä–∫–∞ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫ (4 –º–∏–Ω—É—Ç—ã)..."
        timeout 4m ./gradlew :TMessagesProj:assembleDebug --no-daemon -x check -x test -x lint -x verify &
        BUILD3_PID=$!
        source timer.sh "–°–±–æ—Ä–∫–∞ 3" $BUILD3_PID &
        TIMER3_PID=$!
        wait $BUILD3_PID && echo "‚úÖ –°–±–æ—Ä–∫–∞ 3 —É—Å–ø–µ—à–Ω–∞!" || \
        
        (kill $TIMER3_PID 2>/dev/null || true
        echo "üîß –ü–æ–ø—ã—Ç–∫–∞ 4: –ü—Ä–æ—Å—Ç–æ —Å–æ–±—Ä–∞—Ç—å APK (5 –º–∏–Ω—É—Ç)..."
        timeout 5m ./gradlew assembleDebug --no-daemon --stacktrace &
        BUILD4_PID=$!
        source timer.sh "–°–±–æ—Ä–∫–∞ 4" $BUILD4_PID &
        TIMER4_PID=$!
        wait $BUILD4_PID && echo "‚úÖ –°–±–æ—Ä–∫–∞ 4 —É—Å–ø–µ—à–Ω–∞!" || \
        
        (kill $TIMER4_PID 2>/dev/null || true
        echo "‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
        exit 1))))))
        
    - name: üì¶ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: KotuktoperGram-Liquid
        path: |
          **/build/outputs/apk/**/*.apk
          **/app/build/outputs/apk/**/*.apk
          **/TMessagesProj/build/outputs/apk/**/*.apk
        if-no-files-found: warn
        retention-days: 30
